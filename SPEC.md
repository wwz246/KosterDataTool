# 科斯特工作站电化学数据处理（SPEC）

> 本文件为《科斯特工作站电化学数据处理v1.0.docx》规则的 Markdown 版本，用于代码实现与回归测试依据。  
> 术语约定：program_dir = 程序（exe）所在文件夹；root_path = 用户选择的根目录。

---

## 1 目标与适用范围

### 1.1 目标
对用户选择的根目录下电化学文本数据自动完成：
1. 扫描识别电池与工况文件；
2. 解析数据并按圈分割；
3. 按用户指定圈数导出 CV/GCD/EIS 曲线；
4. 对 GCD 逐圈计算：充/放电比容量、充/放电比电容、库伦效率、R↓ 和 R_turn；
5. 生成 Excel：极片级汇总工作簿（必输出）与电池级工作簿（可选输出，默认勾选）。

### 1.2 目录结构
仅支持两种结构（扫描时自动识别）：
- 结构 A（单电池）：根目录下直接放 CV/GCD/EIS 文件；电池名 = 根目录名。
- 结构 B（多电池）：根目录下一级子文件夹 = 电池；电池名 = 子文件夹名；文件位于子文件夹内。

深层目录（深度 >2）一律跳过但不中止扫描：
- 必须统计并展示“跳过目录数/跳过文件数”
- 把所有被跳过的绝对路径写入 `program_dir\KosterData\reports\skipped_paths-<run_id>.txt`
- 结束弹窗也必须展示该文件路径。

---

## 2 exe 程序运行流程

### 2.1 运行数据目录（固定在程序所在文件夹）
本程序仅支持 Windows 10/Windows 11 的 64 位系统。除导出的 2 个 Excel 文件外（见第 16 节），所有运行态数据一律保存在 `program_dir\KosterData` 下。

程序启动时必须检测 `program_dir` 是否可写：
- 若不可写（无创建/写入权限），则立即终止并弹窗提示：  
  **“程序所在文件夹不可写，请将程序放到可写目录（例如桌面/文档）后重试”**

`program_dir\KosterData` 目录结构（必须创建）：
- `config\config.yaml`（可选；不存在则使用内置默认配置）
- `state\last_root.txt`（UTF-8，保存上一次成功选择的根目录绝对路径）
- `state\last_cleanup.txt`（UTF-8，保存上一次执行 30 天清理的日期，格式 YYYY-MM-DD）
- `logs\run_<run_id>.log`（UTF-8 纯文本日志）
- `logs\run_<run_id>.jsonl`（UTF-8 结构化日志，每行 1 条 JSON）
- `reports\run_<run_id>_report.txt`（失败/告警清单与关键统计）
- `reports\skipped_paths-<run_id>.txt`（被跳过的深层目录/文件清单）
- `cache\`（解析缓存）
- `temp\run_<run_id>\`（本次运行临时文件目录）

run_id 固定格式：`YYYYMMDD_HHMMSS`（例如 `20260214_073015`）。

#### 30 天清理规则（固定）
程序每次启动时读取 `state\last_cleanup.txt`：
- 若文件不存在则创建并写入当天日期
- 若距离上次清理 >= 30 天，则执行清理并将该文件更新为当天日期

清理范围固定为：
- `KosterData\logs`
- `KosterData\reports`
- `KosterData\cache`
- `KosterData\temp`

清理内容：删除其中“最后修改时间早于当前时间 30 天”的所有文件与空目录。  
`config` 与 `state` 永不自动删除。

---

### 2.2 GUI 运行流程（单窗口，两步页面）
程序启动后打开同一个主窗口。窗口顶部显示标题：**“科斯特工作站电化学数据处理”**。  
中部为两步页面：步骤 1（根目录与扫描）与步骤 2（参数确认与导出）。

#### 步骤 1：根目录与扫描
1) 点击按钮“科斯特数据处理”弹出根目录选择框。默认打开路径：
   - 读取 `program_dir\KosterData\state\last_root.txt` 的上一级  
   - 首次运行或路径失效则打开 `program_dir`
2) 用户选择根目录后，界面仅显示路径并启用按钮“开始扫描”；禁止在选择目录后自动扫描。
3) 点击“开始扫描”才开始扫描；左下角进度区必须实时显示：  
   **阶段、当前对象、百分比、已识别电池数、已识别文件数、已跳过目录数、已跳过文件数**
4) 扫描过程中必须提供按钮“取消扫描”：点击后立即停止扫描并保留已扫描结果；允许用户再次点击“开始扫描”重新扫描（重新扫描前必须清空上一次扫描结果）。
5) 扫描阶段只做：**文件识别 + 可用工况统计 + 最大圈数粗统计**
6) 扫描结束后自动切换到步骤 2，并填充电池列表、最大圈数（未知则显示 ‘-’）与可用工况列表；同时在 `program_dir\KosterData\reports` 下生成 `skipped_paths-<run_id>.txt`。

#### 步骤 2：参数确认与导出
1) 用户输入/粘贴参数后（可选：仅对极片级工作簿筛选工况；电池级工作簿始终输出所有识别到的工况）点击“确定导出”开始执行“完整解析→计算→导出 Excel”。  
   必须在窗口左下角显示进度条，阶段顺序固定为：  
   **参数校验 → 逐文件解析/分圈/选圈 → GCD 分段与计算 → 生成 Excel → 保存 → 结束弹窗（失败/告警清单）**
2) 本程序不提供单独的输出目录选择：导出的 2 个 Excel 文件固定保存到用户选择的根目录（见第 16 节）。
3) 提供复选框“完成后打开输出文件夹”，默认勾选；完成后打开的输出文件夹固定为根目录。若系统限制无法打开，需提示但不影响导出。
4) 提供按钮“返回步骤 1”（不关闭窗口）：返回时保留当前参数（见第 4 节缓存规则）。

---

### 2.3 CLI 形态（用于调试与回归测试）
必须提供 CLI 形态并复用同一核心逻辑（仅 UI 不同）。  
CLI 参数示例：`--root <dir> --no-gui --selftest`。

CLI 运行时：
- 导出的 2 个 Excel 文件仍固定保存到 `--root` 指定的根目录
- 日志与报告仍固定写入 `program_dir\KosterData`
- CLI 结束时必须打印日志路径与报告路径

---

### 2.4 日志与可维护性（稳定性硬要求）
1) 全流程必须记录日志：包含版本号、运行形态(GUI/CLI)、run_id、根目录、每个文件的识别结果、列映射结果、关键校验失败原因与堆栈。
2) 任何单文件失败不得导致整批崩溃：逐文件 try/except，失败文件进入失败清单，其余继续；但若为全局致命错误（根目录不可读/不可写、模板缺失、依赖缺失、program_dir 不可写）则立即终止并弹窗/打印明确原因。
3) 计算口径与 UI/IO 必须解耦：至少拆分为（读取与预清洗、列识别与单位换算、GCD 分段与计算、Excel 写入、UI/CLI 壳）。
4) 失败清单与告警清单必须写入 `program_dir\KosterData\reports\run_<run_id>_report.txt`；结束弹窗必须展示该报告路径。

---

### 2.5 exe 打包要求（能打包、能运行、能定位问题）
1) 推荐 PyInstaller 打包。默认采用 onedir（文件夹）模式，并确保 `program_dir\KosterData` 可写。
2) 如需 onefile：仍要求 `program_dir\KosterData` 写在 exe 同级目录；禁止把运行态数据写入 `sys._MEIPASS`。
3) 资源路径必须兼容打包：统一用 `resource_path` 机制，兼容 `sys._MEIPASS`。
4) 依赖必须固定并可复现：提供 `requirements.txt` 锁定版本；禁止运行时在线下载依赖。
5) 必须提供 selftest（内置小样例或生成模拟数据）验证“读表→分段→计算→导出”全链路，确保打包后在无开发环境机器上也能一键自检。

---

## 3 文件识别与工况含义

### 3.1 文件名匹配（大小写不敏感）
仅匹配并处理：
- `CV-<num>.txt`
- `GCD-<num>.txt`
- `EIS-<num>.txt`

其中 `<num>` 允许整数或小数（如 0.05、0.1、0.2、0.5、1、5、10、50）。  
解析得到的 num 必须按数值排序（升序），禁止按字符串排序；num 同值时按文件名稳定排序。

除上述三类文件外，其余任何命名或后缀的文件一律不识别、不参与统计、也不报错。

### 3.2 `<num>` 含义与单位
- CV：扫描速率标签，单位 mV/s。
- GCD：电流密度标签 J_label，单位 A/g。
- EIS：编号标签（用于排序与标题显示）。

---

## 4 UI 规范（单窗口两步页面）

### 4.1 屏幕适配与滚动
关键控件若在屏幕上显示不全，必须提供水平或竖直滚动条，不得出现控件在屏幕外不可见的情况。

### 4.2 主窗口总布局
窗口从上到下分为 3 个区域：上方为标题与步骤指示；中部为内容区（包含 2 个子页面 Tab）；下方为按钮区与进度区。

### 4.3 步骤 1：根目录与扫描
1) “科斯特数据处理”按钮：默认打开路径为 `last_root.txt` 上一级；首次运行或路径失效则打开 `program_dir`。
2) 选择根目录后仅展示路径，不自动扫描；启用“开始扫描”。
3) “开始扫描”：扫描期间“取消扫描”必须可用。
4) “取消扫描”：立即停止并保留已扫描结果；再次“开始扫描”必须先清空旧结果。
5) 进度区显示 7 字段：阶段、当前对象、百分比、已识别电池数、已识别文件数、已跳过目录数、已跳过文件数。
6) 扫描完成自动切到步骤 2，并生成 `skipped_paths-<run_id>.txt`。
7) 步骤 1 与步骤 2 都必须提供“打开跳过清单”按钮：打开 skipped_paths 所在目录，失败则提示完整路径。

### 4.4 步骤 2：上方全局选项（固定显示）
1) 输出类型：Csp（F/g）或 Qsp（mAh/g）。
2) 几何面积 A_geom（cm²）：默认 1。仅当源数据含 “/cm²” 或 “Ω·cm²” 时参与换算。
3) 是否输出电池级工作簿：默认勾选。
4) 完成后打开输出文件夹：默认勾选，打开根目录；失败提示但不影响导出。
5) “打开运行报告”按钮：打开 run_report 所在目录，失败则提示完整路径。

### 4.5 子页面 1：参数表（每行一个电池）
#### 4.5.1 字段与显示
只读列（灰色不可编辑）：电池名、CV 最大圈数、GCD 最大圈数。  
可编辑列（中文(单位)显示；内部映射英文变量）：
- 正极质量 m_pos (mg)
- 负极质量 m_neg (mg)
- 活性占比 p_active (%)
- CV 选圈 N_CV
- GCD 选圈 N_GCD
- 起始电压 V_start (V)
- 终止电压 V_end (V)
- 折算因子 K：仅当输出类型=Csp 时显示并必填；输出类型=Qsp 时隐藏且内部固定 K=1

质量口径提示（必须明示）：半电池其中一侧质量请填 0；质量均为不含集流体的活性层质量。

#### 4.5.2 选区、单值填充与多值粘贴（Excel 风格）
- 支持鼠标拖拽矩形选区
- 左侧固定输入框 + “单值填充”按钮：写入所有选中可编辑单元格（只读列跳过）
- 多值粘贴：支持二维矩阵；左上角对齐；超出丢弃；不足保持原值；支持 Ctrl+C/Ctrl+V；提供“多值粘贴”按钮
- 撤销：仅 1 次撤销（Ctrl+Z），仅对最近一次“单值填充”或“多值粘贴”生效；不支持重做

#### 4.5.3 输入校验与防误操作（必须实现）
- 仅接受数值；非法（空/非数值/越界）即时标红，并悬停提示原因
- 点击“确定导出”全表校验：若存在错误单元格，弹窗提示  
  **“参数存在错误，已定位到第一个错误单元格”**  
  并自动滚动/聚焦到该单元格；禁止开始计算

### 4.6 子页面 2：极片级筛选列表（仅结构 B 多电池时出现）
- 仅结构 B 显示该子页面
- 多选列表：电池、CV 工况、GCD 工况、EIS 工况
- 默认选择（固定，按数值比较）：
  - 电池：全选
  - CV：最小 num
  - GCD：最小 num
  - EIS：最大 num
- 筛选仅影响极片级工作簿；电池级工作簿不受影响，始终输出全部识别工况

### 4.7 下方按钮与缓存规则
按钮区固定 3 个按钮：
1) 返回上一步（仅步骤2显示）
2) 清空缓存
3) 确定导出

缓存规则（固定）：
- 从步骤2返回步骤1时，参数表必须缓存到 `program_dir\KosterData\cache\ui_cache.json`，以 root_path 为唯一键
- 若步骤1选择不同 root_path，必须清空缓存并用新扫描结果初始化

---

## 5 参数校验

### 5.1 必填项
每电池必填：m_pos、m_neg、p_active、N_CV、N_GCD、V_start、V_end。  
输出类型=Csp：K 必填且 K>0。  
全局必填：A_geom（允许默认 1，但必须存在且可解析为数值）。

### 5.2 取值范围
- m_pos ≥ 0，m_neg ≥ 0，且 (m_pos + m_neg) > 0
- 10 < p_active ≤ 100
- N_CV、N_GCD 为正整数，且不超过扫描最大圈数
- V_start < V_end
- A_geom > 0

### 5.3 数据一致性强校验（GCD）
对每个 `GCD-<num>.txt`：
1) ΔQ 获取优先级固定：
   - I(A) 列
   - j(A/cm²) 列 × A_geom
   - 容量列差分（按窗口段端点差分）
   - 若采用容量差分必须记录 W5101：“缺电流，已用容量列差分计算 ΔQ”，并写 ΔQ_source=capacity  
   - 若三种方式均不可得：该文件失败 E5102：“缺电流且缺容量列，ΔQ 无法计算”
2) 电压窗截取强校验：逐圈检查充/放主段能否完成“达到/穿越 + 截取 + 线性插值”。若某圈无法完成截取：该文件失败 E5201：“选定圈无法按电压窗截取”。曲线导出不受影响。

### 5.4 规则
不通过禁止导出并让用户修改相应值，错误参数红字显示，修改好之后红色提示消失，用户可重新点击确定再次启动。

---

## 6 通用读表与列识别

### 6.1 强制预清洗层、表头识别与分隔符
预清洗（先于任何表头/列名识别）：
- 剥离 UTF-8 BOM（\ufeff）
- 跳过 `CSStudioFile,` 开头行或包含 `H4sIA` 的行
- 仅遇到候选分隔符表格行后进入切分统计

候选分隔符：`\t`、`,`、`;`、`\s{2,}`、`\s+`（仅其他失败时启用）

切分前必须按 6.4 预抽取并剥离 `k CYCLE` 标记（保证不参与列数统计）。

严格数值 token：`^[+-]?(\d+(\.\d*)?|\.\d+)([eE][+-]?\d+)?$`，空 token 忽略。

短行/不齐列过滤（强制）：
- 统计 numCols，modeCols 为众数列数
- 仅保留 numCols==modeCols 行；其余丢弃并记录 W6101（写入 jsonl 与 run_report）
- 需满足保留占比 ≥ 80% 才认为分隔符有效

表头识别：
- 优先从预清洗前原始文本定位含关键词行
- 未找到表头：CV/GCD 允许无表头推断；EIS 若无法稳定推断则失败 E6101（写入 run_report/jsonl/CLI/弹窗）

列映射结果必须写日志：含 no-header mapping。

无表头推断（默认 CV/GCD；EIS 仅可稳定识别时启用）：
- t：整体单调递增且跨度最大
- E：落在 [V_start-1, V_end+1] 或 0-5V 范围
- I/j：段内近似常数，允许正负号变化；含 /cm² 则优先判 j 并按 A_geom 得 I
- Step/Cycle：离散小整数分段常值优先 Step；从 1 递增并反复优先 Cycle
推断成功必须写日志：列号与推断理由摘要；推断失败则报错并入失败清单（EIS：E6101）。

### 6.2 等价列名与归一化
列名归一化：小写、去空白、去常见符号、全角转半角；括号单位保留用于换算但匹配时忽略。  
等价列名匹配（含中英文）：
- 时间：Time / 时间 / t
- 电压：Voltage / 电压 / E / Potential
- 电流：Current / 电流 / I
- 电流密度：Current density / 电流密度 / j / i（单位含 /cm² 按电流密度）
- Step：Step / 工步
- 充电容量：ChargeCapacity
- 放电容量：DischargeCapacity
- 阻抗：Z’、Z’’（或等价写法）

### 6.3 单位换算
- t→s；E→V
- I→A（mA/µA 换算）
- 容量→mAh（Ah/µAh 换算）
- 电流密度：j→A/cm² 后 I=j*A_geom
- 阻抗：若为 Ω·cm² 等面积比阻抗，Z=Z_A/A_geom
- 若出现 mm²/m²，先换算到 cm² 再执行上述规则

### 6.4 “k CYCLE” 标记（强制口径）
- 独立行：`^\s*(\d+)\s*CYCLE\s*$`
- 行尾追加：`(\d+)\s*CYCLE\s*$`
记录 markerEvent={rawLineIndex,k,isStandalone}；行尾仅剥离子串；独立行不进入数据行但 markerEvent 保留；k CYCLE 不参与列统计。

---

## 7 分圈规则
- GCD：优先 Cycle 列；否则 k CYCLE
- CV：k CYCLE
- EIS：不分圈

k CYCLE 分圈：
- 无标记 maxCycle=1
- 有标记：N_max=max(k)，若最后标记后仍有数据行则 maxCycle=N_max+1 否则 N_max
- pos(r)=max{j | dataRow(j).rawLineIndex<=r}
- 同 k 多次取 rawLineIndex 最大
- endIdx(k) 非单调夹紧并告警
- 圈范围：
  - 1圈：dataRow 1..endIdx(1)
  - k圈：endIdx(k-1)+1..endIdx(k)
  - 末圈：endIdx(N_max)+1..末尾

---

## 8 选圈与导出总原则
- CV：每个 CV-<num> 导出第 N_CV 圈
- GCD：曲线导出用第 N_GCD 圈；逐圈计算覆盖 1..最大圈
- EIS：整文件
- 曲线导出不按电压窗截取；计算使用电压窗截取+插值（见 11.1.1）

---

## 9 质量归一与活性质量
- m_basis(mg)=m_pos+m_neg
- m_active(g)=(m_basis*p_active/100)/1000

---

## 10 GCD 分段与主顺序
- Step 优先；无 Step 用电流换向分段；极短静置合并
- epsI=max(1e-9,1e-3*|J_label*m_active|)
- 充/放判定以电压趋势为主；平台段并入邻主段；不稳告警并回退电流符号
- 异常段告警：电流符号不稳/电压不单调
- 主顺序：从第2圈起投票；不稳回退第2圈并告警
- 首圈反向小段剔除：仅首圈起始处且结束不晚于30%时长

---

## 11 GCD 指标计算
- 原始端点用于 R↓/R_turn；窗口端点用于 Δt/ΔQ 等
- 电压窗截取与线性插值（含 ±5 点搜索窗）
- Δt、Δt_samp、ΔQ（梯形积分）、ΔQ_eff（2..n-1）、ΔV_noIR、ΔV_eff（E_n - E_2）
- R↓=|E_seg1,end - E_seg2,start|
- ΔI_turn=|I_seg2,start - I_seg1,end|（必须用带符号电流做差后取绝对值）
- 缺电流：R_turn=NaN 并告警“缺电流无法算R_turn”
- Qsp、Csp(noIR/eff)、CE 使用未取整 ΔQ 计算

---

## 12 曲线导出（CV/GCD/EIS）
- CV：Voltage + Specific Current(A/g)；/cm² 则 I=j*A_geom；保留正负号；导出第 N_CV 圈；块三行表头规则
- GCD：Time(s) 圈内归零 + Voltage(V)；剔除静置/无效段；首圈反向段按 10.5 剔除；导出第 N_GCD 圈；块三行表头规则
- EIS：Z'(ohm) + -Z''(ohm)（取负）；Ω·cm² 需先除 A_geom；块三行表头规则

---

## 13 Rate 与 Retention
- Rate 代表值：Csp 模式取主顺序下第二主段；Qsp 模式取 Qsp_dis
- 列结构：Csp=5列；Qsp=2列；按指定顺序
- Retention：Rate 写完空一行再写；基准 X0/X1；X0 缺失或<=0 则整列 NA 并告警 W1304（写入 jsonl 与 run_report）

---

## 14 Excel 输出：极片级与电池级
- 极片级受筛选；电池级不受筛选
- 三行表头 + 数据从第4行
- 电池级区块顺序：CV→空列→GCD→空列→EIS→空列→指标；区块内部不插空列
- 极片级多电池横排：块与块之间不插空列；电池按电池名升序
- 电池级固定结构：参数汇总 sheet + 每电池一个 sheet

---

## 15 电池级“参数汇总”sheet
- 15.1 参数表（每电池一行，字段列表见原文）
- 参数表与逐圈结果表之间插入 5 空白行
- 15.2 逐圈结果表：维度=每电池×每GCD工况×每圈；字段包含 Qsp_chg/Qsp_dis、Csp_eff、CE、R↓、R_turn 等

---

## 16 输出文件命名与保存
根目录只允许生成 2 个 Excel 文件，其余任何文件（日志/报告/跳过清单/缓存/临时文件）禁止落 root。  
导出的 2 个 Excel 文件固定保存到根目录：
- `<根目录名>-极片级-<Csp|Qsp>-<run_id>.xlsx`
- `<根目录名>-电池级-<Csp|Qsp>-<run_id>.xlsx`

若重名：自动追加 `_1,_2,...`，禁止静默覆盖。  
报告固定保存到 `program_dir\KosterData\reports`；日志固定保存到 `program_dir\KosterData\logs`。  
结束弹窗必须显示：根目录、2个Excel文件名、运行报告路径与日志路径，并列出失败/告警清单（至少前50条，完整见运行报告）。

---

## 17 数字格式与计算顺序
所有指标必须先用未取整值计算，最后仅在写 Excel/显示时格式化：
1) Csp：显示为整数（四舍五入0.5进1），保持率/统计用未取整值
2) Qsp：显示 2 位小数
3) R↓、R_turn：显示 2 位小数
4) Retention：基于未取整指标计算，显示 2 位小数
5) CE：基于未取整 ΔQ 计算，显示 2 位小数；禁止由取整后的 Qsp/Csp 反推 CE
